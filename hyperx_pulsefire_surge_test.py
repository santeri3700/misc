#!/usr/bin/env python3
import usb.core
import usb.util

# Interface of the USB device
dev_interface = 1

try:
    # Find the device
    dev = usb.core.find(idVendor=0x0951, idProduct=0x16D3)
    # ID 0951:16D3 Kingston Technology HyperX Pulsefire Surge
except Exception as e:
    print("Error: " + str(e))

if dev == None:
    print("USB device not found!")
    exit(1)

try:
    # Detach the currently used kernel driver
    dev.detach_kernel_driver(dev_interface)
    usb.util.claim_interface(dev, dev_interface)
    dev.set_interface_altsetting(interface=dev_interface, alternate_setting=0)

    print("Driver detached and claimed! Mouse will be unusable for a moment.")
except Exception as e:
    print("Error: " + str(e))
    exit(1)

# DPIs
dpi_1 = 0x0a # 0x0a = 500  dpi
dpi_2 = 0x14 # 0x14 = 1000 dpi
dpi_3 = 0x1e # 0x1e = 1500 dpi

# Color
red = 0x00
green = 0xff
blue = 0x00

# Effect
effect = 0x00 # Solid
#effect = 0x01 # Cycle (Rainbow?) -- WARNING: Might need other packet changes!!!
#effect = 0x02 # Breathing
#effect = 0x03 # Wave
#effect = 0x04 # Trigger

# "Wake up packet" number 1. This is always the same?
data_packet1 = [
0x07, 0x03, 0x04, 0x01, 0x01, 0x01, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 ]

# "Wake up packet" number 2. This is also always the same?
data_packet2 = [
0x07, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x02, 0x02, 0x02, 0x0a,
0x0a, 0x0a, 0x0a, 0x16, 0x16, 0x16, 0x28, 0x28, 0x28, 0x28, 0x3f, 0x3f, 0x3f, 0x3f, 0x5b, 0x5b,
0x5b, 0x5b, 0x7b, 0x7b, 0x7b, 0xa2, 0xa2, 0xa2, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe,
0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe,
0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x0e, 0xff, 0xff, 0x24, 0xd8, 0x8d,
0xff, 0xff, 0xff, 0x00, 0x0a, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 ]

# SET_REPORT packet (#3). This contains the color, dpi and effect data etc.
data_packet3 = [
0x07, 0x01, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, dpi_1, 0x00, dpi_2, 0x00, dpi_3, 0x01, 0x80, 0x00,
0x40, 0x01, 0x08, 0x00, dpi_1, 0x00, dpi_2, 0x00, dpi_3, 0x01, 0x80, 0x00, 0x40, 0x01, 0x08, 0x00,
0x01, 0x01, 0x01, 0x00, 0x00, 0x02, 0xf0, 0x00, 0x00, 0x02, 0xf1, 0x00, 0x00, 0x02, 0xf2, 0x00,
0x00, 0x71, 0xf0, 0x00, 0x00, 0x02, 0xf9, 0x00, 0x00, 0x02, 0xf8, 0x00, 0x00, 0x02, 0xf4, 0x00,
0x00, 0x02, 0xf3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
0x01, effect, 0x03, 0x03, 0x03, 0x00, 0x28, 0x00, 0x28, 0x00, 0x28, 0x00, 0x28, 0x28, 0x00, 0x00,
0xf0, 0x00, 0xf0, 0x00, red, green, blue, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, red, 0x00, 0x00,
green, 0x00, 0x00, blue, 0x00, 0x00, red, red, red, red, red, red, red, red, red, red,
red, red, red, red, red, red, red, red, red, red, red, red, red, red, red, red,
red, red, red, red, red, red, green, green, green, green, green, green, green, green, green, green,
green, green, green, green, green, green, green, green, green, green, green, green, green, green, green, green,
green, green, green, green, green, green, blue, blue, blue, blue, blue, blue, blue, blue, blue, blue,
blue, blue, blue, blue, blue, blue, blue, blue, blue, blue, blue, blue, blue, blue, blue, blue,
blue, blue, blue, blue, blue, blue, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, red, 0x00, 0x00, green,
0x00, 0x00, blue, 0x00, 0x00, red, 0x00, 0x00, green, 0x00, 0x00, blue, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 ]

#print("DATA")
#print(str(data_packet1))
#print("\n")

print("RED    : " + str(red) + " (" + format(red, '#04x') + ")")
print("GREEN  : " + str(green) + " (" + format(green, '#04x') + ")")
print("BLUE   : " + str(blue) + " (" + format(blue, '#04x') + ")")
print("EFFECT : " + str(effect) + " (" + format(effect, '#04x') + ")")

print("DPI_1: " + str(dpi_1) + " (" + format(dpi_1, '#04x') + ")")
print("DPI_2: " + str(dpi_2) + " (" + format(dpi_2, '#04x') + ")")
print("DPI_3: " + str(dpi_3) + " (" + format(dpi_3, '#04x') + ")")

try:
    # Send the data to the mouse
    ctrl_transfer_result1 = dev.ctrl_transfer(bmRequestType=0x21, bRequest=0x09, wValue=0x0307, wIndex=0x0001, data_or_wLength=data_packet1,timeout=1000)
    print("Data 1 sent! Result: " + str(ctrl_transfer_result1))

    ctrl_transfer_result2 = dev.ctrl_transfer(bmRequestType=0x21, bRequest=0x09, wValue=0x0307, wIndex=0x0001, data_or_wLength=data_packet2,timeout=1000)
    print("Data 2 sent! Result: " + str(ctrl_transfer_result2))

    ctrl_transfer_result3 = dev.ctrl_transfer(bmRequestType=0x21, bRequest=0x09, wValue=0x0307, wIndex=0x0001, data_or_wLength=data_packet3,timeout=1000)
    print("Data 3 sent! Result: " + str(ctrl_transfer_result3))


    # Release the device and load the default driver
    usb.util.release_interface(dev, dev_interface)
    dev.attach_kernel_driver(dev_interface)

    print("Driver reattached! Mouse should be usable now.")
except Exception as e:
    print("Error: " + str(e))
    exit(1)

print("Bye")
